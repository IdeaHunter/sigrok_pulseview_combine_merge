# Example for combining sigrok .sr files

As of PulseView 0.5.0-git-9d307c6 / libsigrok 0.6.0-git-d7df9dc, there is no facility, that would allow combining captures from .sr files.

For instance, in Audacity, which is an audio editor, but shares the visualisation of waveform tracks with PulseView, if the user does File/Import/Audio... once at first, a new session will be opened, and the audio tracks from the file will be added to this session. If the user then does File/Import/Audio... a second time, importing a second file, then the tracks from the second file will be added to the track list of the session - creating a session that contains the combination of the audio tracks from both files.

However, if the user does something similar in PulseView - a new session will be opened for each import, thereby making it impossible to create a session which contains waveforms/data from multiple files.

One of the essential things to note is that, Audacity can handle different sample rates for each track, while also having a sample rate for the entire project/session ( see e.g. https://superuser.com/questions/420531/audacity-resampling ; http://www.dynamicsoflanguage.edu.au/research/data-archives/guides/resampling-audio-using-audacity/ ) .

On the other hand, PulseView (at the time of writing, at least) assumes that there is a single sample rate used in the entire session; thus, in order to start considering merging different tracks/data into a single session in PulseView, we must first consider how to bring all this data under the same sampling rate - that is, we need to consider resampling.

In this example, we consider a simple Arduino application, driven by an analog signal and with output digital signals; this application will be captured by Saleae Logic in mixed mode (both analog and digital capture), which Saleae Logic typically captures with different sampling rates. Then we consider export from Saleae Logic into formats that can be imported into PulseView, from where we will save them as the native `.sr` format - which will also inherit the differing sampliing rates. Finally, we look into how can we resample the relevant data, so they are end up under the same sampling rate - which will facilitate merging all of this data into a single session.


## Data input

The audio waveform is a "chirp", generated by Audacity, using:

* Generate/Chirp: Waveform: Sine, Start: 440 Hz Amplitude 1.0, End: 1320 Hz Amplitude 1.0, Interpolation: Linear, Duration: 1 sec
* At end of the above chirp: Generate/Silence, 0.5 sec
* This is exported as 16-bit, 44100 Hz mono .wav file, `chirp_base.wav`.

When this file is reproduced out of the PC soundcard on max volume, a max ampliture of about Â± 1.75 V can be measured on oscilloscope (note that Saleae Logic cannot measure the negative semiperiod below -1V!)


## Test Arduino schematic and code

The example Arduino code is taken from [Analog Comparator Interrupt](https://forum.arduino.cc/index.php?topic=149840.msg1135919#msg1135919) - and here it is implemented in [sketch_arduino_analog_comp_test/](sketch_arduino_analog_comp_test/).

The schematic that shows the routing for this test code is shown in [img/arduino_test_schematic.png](img/arduino_test_schematic.png).

The code sets up an analog comparator: the negative input of the comparator (Arduino pin 7) is held on ground, and it represents the comparison threshold at 0V; while the positive input of the comparator is driven by the (mono) channel of the audio, as reproduced by the PC. When the audio channel signal crosses the comparator threshold, an interrupt is raised, where pin 13 of the Arduino is toggled.

On the other hand, the Arduino main loop runs with a 100 ms delay (sleep), and whenever it runs, it copies the state of the comparator to Arduino pin 9.

Finally, with Saleae Logic, we capture the following signals:

* The channel audio, captured as analog signal, as Saleae Logic Ch.0 (usually marked with black color)
* The pin 13 of Arduino (here, as interrupt indicator), captured as digital signal, as Saleae Logic Ch.1 (usually marked with brown color)
* The pin 9 of Arduino (here, as "slow" comparator state indicator), captured as digital signal, as Saleae Logic Ch.2 (usually marked with red color)

When capturing in mixed mode (both analog and digital signals) with Saleae Logic 1.2.18, one cannot arbitrarily choose the sampling rates for analog and digital signals; so the following captures were performed of this test setup:

1. [data/6.25MHz_digital_1.5625MHz_analog_3sec.logicdata](data/6.25MHz_digital_1.5625MHz_analog_3sec.logicdata) - 6.25 MHz digital sampling rate, with 1.5625 MHz analog sampling rate, 3-second capture

    [![6.25MHz_digital_1.5625MHz_analog_3sec](img/6.25MHz_digital_1.5625MHz_analog_3sec-Saleae_Logic.png)](img/6.25MHz_digital_1.5625MHz_analog_3sec-Saleae_Logic.png)

2. [data/500MHz_digital_0.125MHz_analog_5sec.logicdata](data/500MHz_digital_0.125MHz_analog_5sec.logicdata) - 500 MHz digital sampling rate, with 125 kHz analog sampling rate, 5-second capture

    [![6.25MHz_digital_1.5625MHz_analog_3sec](img/500MHz_digital_0.125MHz_analog_5sec-Saleae_Logic.png)](img/500MHz_digital_0.125MHz_analog_5sec-Saleae_Logic.png)


So - the goal of this exercise, is to bring all of these captures in a single PulseView session.
